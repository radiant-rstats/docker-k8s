# Containerfile for rootless Podman
# Optimized for running without root privileges
#
# Build with:
#   podman build -t rsm-podman:latest -f Containerfile .
#
# Run with rootless podman (--userns=keep-id maps host user to container user):
#   podman run -d --name rsm-podman --userns=keep-id \
#     -p 2222:2222 -p 8282:8282 -p 8765:8765 \
#     -v ~/:/home/jovyan \
#     -v pg_data:/var/lib/postgresql/16/main \
#     rsm-podman:latest
#
# Key rootless considerations:
# - SSH runs on port 2222 (non-privileged)
# - PostgreSQL runs on port 8765 (non-privileged)
# - All services run as jovyan user (UID 1000)
# - Use --userns=keep-id to map host user to container user

FROM quay.io/jupyter/pyspark-notebook:2025-12-15

USER root

# Define build argument and set it as an environment variable
ARG IMAGE_VERSION=latest
ENV IMAGE_VERSION=${IMAGE_VERSION}

# Get platform info for conditional logic
ARG TARGETPLATFORM
ARG TARGETOS
ARG TARGETARCH

# Ensure NB_USER is set
ENV NB_USER=${NB_USER:-jovyan}

# Quarto version
ENV QUARTO_VERSION="1.9.13"
ENV PATH="/usr/local/bin:$PATH"

# Postgres env variables
ENV POSTGRES_VERSION=16
ENV PGPASSWORD=postgres

# Jupyter and shell environment setup
ARG RSMBASE=/home/${NB_USER}/.rsm-msba
ENV RSMBASE=${RSMBASE} \
    SHELL=/bin/zsh \
    ZDOTDIR=/home/${NB_USER}/.rsm-msba/zsh

# Set platform-specific variables based on architecture
RUN if [ "${TARGETARCH}" = "arm64" ]; then \
    echo "export IMAGE_NAME=rsm-podman-arm" >> /etc/environment && \
    echo "export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-arm64/" >> /etc/environment && \
    echo "export PGWEB_FILE=pgweb_linux_arm64_v7.zip" >> /etc/environment; \
    elif [ "${TARGETARCH}" = "amd64" ]; then \
    echo "export IMAGE_NAME=rsm-podman-intel" >> /etc/environment && \
    echo "export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/" >> /etc/environment && \
    echo "export PGWEB_FILE=pgweb_linux_amd64.zip" >> /etc/environment; \
    else \
    echo "Unsupported architecture: ${TARGETARCH}" && exit 1; \
    fi

# Source the environment file
RUN . /etc/environment

# Install base packages
COPY files/init-apt.sh setup.sh
RUN chmod +x setup.sh && ./setup.sh && rm setup.sh

# PostgreSQL configuration
COPY files/postgres/postgresql.conf /etc/postgresql/${POSTGRES_VERSION}/main/postgresql.conf
COPY files/postgres/pg_hba.conf /etc/postgresql/${POSTGRES_VERSION}/main/pg_hba.conf

# Install PostgreSQL
COPY files/postgres/install-postgres-mp.sh setup.sh
RUN chmod +x setup.sh && ./setup.sh && rm setup.sh

# Copy postgres init script for runtime initialization (fresh volume mounts)
COPY files/postgres/init-postgres-db.sh /usr/local/bin/init-postgres-db.sh
RUN chmod +x /usr/local/bin/init-postgres-db.sh

# Install SSH server (configured for port 2222 - non-privileged)
COPY files/install-sshd.sh setup.sh
RUN chmod +x setup.sh && ./setup.sh && rm setup.sh

# Install Quarto
COPY files/install-quarto.sh setup.sh
RUN chmod +x setup.sh && ./setup.sh && rm setup.sh

# Install uv package manager
COPY files/install-uv.sh setup.sh
RUN chmod +x setup.sh && ./setup.sh && rm setup.sh

# Setup Hadoop
ENV HADOOP_VERSION=3.3.4
ENV HADOOP_HOME=/opt/hadoop
ENV HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop
COPY files/install-hadoop.sh setup.sh
RUN chmod +x setup.sh && ./setup.sh && rm setup.sh

# Hadoop configuration
ADD files/scalable_analytics/core-site.xml $HADOOP_HOME/etc/hadoop/
ADD files/scalable_analytics/hdfs-site.xml $HADOOP_HOME/etc/hadoop/
ADD files/scalable_analytics/init-dfs.sh /opt/hadoop/
ADD files/scalable_analytics/start-dfs.sh /opt/hadoop/
ADD files/scalable_analytics/stop-dfs.sh /opt/hadoop/
RUN chown -R ${NB_USER} ${HADOOP_HOME} && \
    chmod 755 ${HADOOP_HOME}/*.sh && \
    chmod 755 /usr/bin/hadoop
ENV PATH=$PATH:$HADOOP_HOME/bin

# Install pgweb with platform-specific binary
RUN . /etc/environment && \
    wget -O pgweb.zip https://github.com/sosedoff/pgweb/releases/download/v0.11.11/$PGWEB_FILE && \
    unzip pgweb.zip -d pgweb_dir && \
    mv pgweb_dir/* /usr/local/bin/pgweb_binary && \
    rm -rf pgweb_dir pgweb.zip

# Create log directories with proper permissions for rootless operation
RUN mkdir -p /var/log/postgresql /var/log/sshd && \
    chown jovyan:users /var/log/postgresql && \
    chmod 750 /var/log/postgresql

# Oh-my-zsh and other zsh setup
COPY files/install-ohmyzsh.sh setup.sh
RUN chmod +x setup.sh && ./setup.sh && rm setup.sh

# Setup the GitHub CLI
COPY files/install-gh.sh setup.sh
RUN chmod +x setup.sh && ./setup.sh && rm setup.sh

# Copy CLI scripts
COPY files/zsh/zshrc /etc/skel/.zshrc
COPY files/zsh/p10k.zsh /etc/skel/.p10k.zsh
COPY files/zsh/usethis /usr/local/bin/usethis
COPY files/zsh/interactive-usethis.sh /usr/local/bin/iusethis
COPY files/zsh/github.sh /usr/local/bin/github
COPY files/zsh/scripts/radiant.sh /usr/local/bin/radiant
COPY files/zsh/setup.sh /usr/local/bin/setup
COPY files/zsh/menu.sh /usr/local/bin/menu

RUN fix-permissions /etc/skel && \
    fix-permissions /usr/local/bin && \
    chmod 755 /usr/local/bin/*

# Startup script
COPY files/start-container.sh /usr/local/bin/
COPY files/sshd/sshd_config /etc/ssh/sshd_config
RUN chmod +x /usr/local/bin/start-container.sh

RUN touch /var/log/sshd/sshd.log && \
    chown ${NB_USER}:${NB_GID:-users} /var/log/sshd/sshd.log && \
    chmod 640 /var/log/sshd/sshd.log

# Expose non-privileged ports for rootless operation
# 2222 - SSH
# 8282 - pgweb
# 8765 - PostgreSQL
EXPOSE 2222 8282 8765

CMD ["/usr/local/bin/start-container.sh"]

# Run as non-root user for rootless container operation
USER ${NB_UID}
ENV HOME=/home/${NB_USER}
